{"version":3,"file":null,"sources":["../src/parent.js","../src/iframe.js","../src/index.js"],"sourcesContent":["import jQuery from 'jquery';\nimport formHelper from 'formhelper';\nimport Cookies from 'cookies-js';\nimport Porthole from 'porthole';\n\nconst $ = jQuery;\n\n/**\n * rule –\n *   Standard formRule with a few extra properties:\n *   \n *     form\n *       Default: #formhelper-peer-iframe--parent-form\n *\n *     frame\n *       Default: #formhelper-peer-iframe--iframe'\n *       iframe selector (override as needed)\n *\n *     peerProxyUrl\n *       Required. URL to proxy html file on the *child* domain.\n *       Example: http://child-domain.com/js/porthole/proxy.html\n */\n\nfunction connect(rule) {\n\n  rule = jQuery.extend({\n    form: '#formhelper-peer-iframe--parent-form',\n    frame: '#formhelper-peer-iframe--iframe'\n  }, rule);\n\n  if (!rule.peerProxyUrl) { throw new Error('Missing `peerProxyUrl` in formhelper-peer-iframe/parent.js'); }\n\n  rule.porthole = null;\n\n  function checkReady() {\n    if (!rule.ready) {\n      rule.porthole.post({event: 'fh-ipeer-ready'});\n      window.setTimeout(checkReady, 100);\n    }\n  }\n\n  $(function() {\n\n    const $form = $(rule.form);\n    const $frame = $(rule.frame);\n\n    if ($form.length !== 1 || $frame.length !== 1) return;\n\n    const frameName = $frame.attr('name');\n\n    if (!frameName) { throw new Error('Missing iframe `name` attribute in formhelper-peer-iframe/parent.js'); }\n\n    rule.requestController = FormHelperPeerRequest;\n    rule.ready = false;\n\n    formHelper.addRule(rule);\n\n    rule.porthole = new Porthole.WindowProxy(rule.peerProxyUrl, frameName);\n\n    rule.porthole.addEventListener(function(messageEvent) {\n\n      const data = messageEvent.data;\n\n      switch (data.event) {\n\n        case 'fh-ipeer-child-resize':\n          $frame.height(data.bodyHeight);\n          break;\n\n        case 'fh-ipeer-child-submit':\n          $form.submit();\n          break;\n\n        case 'fh-ipeer-ready':\n          rule.porthole.post({event: 'fh-ipeer-ready-ack'});\n          break;\n\n        case 'fh-ipeer-ready-ack':\n          rule.ready = true;\n          break;\n      }\n\n      if (rule.peerEvents && rule.peerEvents[data.event]) {\n        rule.peerEvents[data.event](data);\n      }\n\n    });\n\n    window.setTimeout(checkReady, 0);\n\n  });\n\n  return rule;\n}\n\n\nfunction FormHelperPeerRequest(formEl, rule, submitEvent) {\n  this.iframeResponse = null;\n\n  this.peerSubmitCompleteHandler = $.proxy(this.peerSubmitCompleteHandler, this);\n  rule.porthole.addEventListener(this.peerSubmitCompleteHandler);\n\n  this.initialize(formEl, rule, submitEvent);\n}\n\nFormHelperPeerRequest.Defaults = {\n  rule:       {},\n  xhrOptions: {}\n};\n\n\nconst FormHelperRequest = formHelper.FormHelperRequest;\nFormHelperPeerRequest.prototype = new FormHelperRequest(null, {});\n\n\n$.extend(FormHelperPeerRequest.prototype, {\n\n  startXHR: function() {\n\n    // Get the form ready to submit...\n    this.checkoutForm();\n    this.hideAllStatusMessages();\n    this.hideAllErrorMessages();\n    this.hideAllParamMessages();\n    this.clearAllErroredFields();\n    this.disableControls();\n\n    // But don't actually submit it yet, just notify the iframe form to do its thing\n    this.rule.porthole.post({event: 'fh-ipeer-parent-submit'});\n  },\n\n  resumeXHR: function(response) {\n\n    this.iframeResponse = response;\n\n    this.xhrOptions.data['peer-status'] = response.status || 'UNKNOWN';\n\n    this.savePeerCookies(response.data);\n\n    FormHelperRequest.prototype.startXHR.call(this);\n  },\n\n  xhrSuccess: function(data, textStatus, jqXHR) {\n\n    if (this.iframeResponse) {\n      if (this.iframeResponse.status !== 'SUCCESS') {\n        data.status = this.iframeResponse.status;\n      }\n      if (this.iframeResponse.errors) {\n        if (data.errors) {\n          data.errors = data.errors.concat(this.iframeResponse.errors);\n        } else {\n          data.errors = this.iframeResponse.errors;\n        }\n      }\n    }\n\n    this.rule.porthole.post({event: 'fh-ipeer-parent-response-received', status: data.status});\n\n    FormHelperRequest.prototype.xhrSuccess.call(this, data, textStatus, jqXHR);\n  },\n\n  savePeerCookies: function(data) {\n    if (!data) return;\n\n    const peerCookies = data.peerCookies;\n\n    if (peerCookies) {\n      for (let i = 0, len = peerCookies.length; i < len; i++) {\n        const cookie = peerCookies[i];\n        Cookies.set(cookie.name, cookie.value, {path: '/'});\n      }\n    }\n  },\n\n  peerSubmitCompleteHandler: function(messageEvent) {\n    const data = messageEvent.data;\n\n    switch (data.event) {\n      case 'fh-ipeer-child-response-received':\n        this.resumeXHR(data.responseData);\n        this.rule.porthole.removeEventListener(this.peerSubmitCompleteHandler);\n        break;\n    }\n  }\n\n});\n\nexport { connect };","import jQuery from 'jquery';\nimport formHelper from 'formhelper';\nimport Porthole from 'porthole';\n\nconst $ = jQuery;\n\n/**\n * rule –\n *   Not a full formRule but the following two properties:\n * \n *     form\n *       Child iframe form's selector (override as needed)\n *       Default: #formhelper-peer-iframe--iframe-form\n *   \n *     peerProxyUrl\n *       Required. URL to proxy html file on the *parent* domain.\n *       Example: http://parent-domain.com/js/porthole/proxy.html\n */\n\nfunction connect(rule = {}) {\n\n  rule = $.extend({\n    form: '#formhelper-peer-iframe--iframe-form',\n    ready: false\n  }, rule);\n\n  if (!rule.peerProxyUrl) {\n    throw new Error('Missing `peerProxyUrl` in formhelper-peer-iframe/iframe.js');\n  }\n\n  let porthole = null;\n  let formHelperRequest = null;\n  let $body = null;\n  let $form = null;\n\n  function resizeFrame() {\n    const bodyHeight = $body.height();\n    porthole.post({event: 'fh-ipeer-child-resize', bodyHeight});\n  }\n\n  function checkReady(cb) {\n    if (rule.ready) {\n      if (cb) { cb(); }\n    } else {\n      porthole.post({event: 'fh-ipeer-ready'});\n      window.setTimeout(_ => {\n        checkReady(cb)\n      }, 100);\n    }\n  }\n\n  function handleParentMessage(messageEvent) {\n\n    const data = messageEvent.data;\n\n    switch (data.event) {\n\n      case 'fh-ipeer-parent-submit':\n        formHelperRequest = new formHelper.FormHelperRequest($form, rule);\n        break;\n\n      case 'fh-ipeer-parent-response-received':\n        if (data.status !== 'SUCCESS') {\n          formHelperRequest.releaseForm();\n        }\n        formHelperRequest.updateUI();\n        resizeFrame();\n        break;\n\n      case 'fh-ipeer-ready':\n        porthole.post({event: 'fh-ipeer-ready-ack'});\n        break;\n\n      case 'fh-ipeer-ready-ack':\n        rule.ready = true;\n        break;\n    }\n\n    if (rule.peerEvents && rule.peerEvents[data.event]) {\n      rule.peerEvents[data.event](data);\n    }\n  }\n\n\n  $(_ => {\n\n    const form = rule.form;\n    const peerProxyUrl = rule.peerProxyUrl;\n\n    $form = $(form);\n\n    if ($form.length !== 1) return;\n\n    $body = $('body');\n\n    porthole = new Porthole.WindowProxy(peerProxyUrl);\n    porthole.addEventListener(handleParentMessage);\n\n    $.extend(rule, {\n      porthole,\n      xhrSuccess() {\n        formHelperRequest = this;\n\n        porthole.post({event: 'fh-ipeer-child-response-received', responseData: {\n          data:   this.data,\n          errors: this.errors,\n          status: this.status\n        }});\n\n      },\n      onComplete() {\n        resizeFrame();\n      },\n      customSubmitHandler() {\n        porthole.post({event: 'fh-ipeer-child-submit'});\n      },\n      releaseFormAndUpdateUIOnXHRSuccess: false\n    });\n\n    formHelper.addRule(rule);\n\n    window.setTimeout(_ => {\n      checkReady(_ => {\n        resizeFrame();\n        $(window).resize(resizeFrame);\n      }, 100)\n    }, 0);\n\n  });\n\n  return rule;\n}\n\nexport { connect };","import { connect as connectParent } from './parent.js';\nimport { connect as connectIframe } from './iframe.js';\n\n/*\n\nNote that for now both the parent and iframe forms are only\nregistered to formhelper if the specified form is found on\nDOMContentLoaded. This is to prevent the Porthole proxy setup\non pages where it's not needed.\n\n*/\n\nexport {\n\tconnectParent as parent,\n\tconnectIframe as iframe\n}\n\n/*\nProxy template:\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <script src=\"/js/a-script-with-porthole.js\"></script>\n    <script>window.onload=function() { Porthole.WindowProxyDispatcher.start(); };</script>\n  </head>\n  <body></body>\n</html>\n*/"],"names":["$","jQuery","connect","rule","extend","peerProxyUrl","Error","porthole","checkReady","ready","post","event","setTimeout","$form","form","$frame","frame","length","frameName","attr","requestController","FormHelperPeerRequest","addRule","Porthole","WindowProxy","addEventListener","messageEvent","data","height","bodyHeight","submit","peerEvents","formEl","submitEvent","iframeResponse","peerSubmitCompleteHandler","proxy","initialize","Defaults","FormHelperRequest","formHelper","prototype","checkoutForm","hideAllStatusMessages","hideAllErrorMessages","hideAllParamMessages","clearAllErroredFields","disableControls","response","xhrOptions","status","savePeerCookies","startXHR","call","textStatus","jqXHR","errors","concat","xhrSuccess","peerCookies","i","len","cookie","set","name","value","path","resumeXHR","responseData","removeEventListener","formHelperRequest","$body","resizeFrame","cb","handleParentMessage","releaseForm","updateUI","window","resize"],"mappings":"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"}