{"version":3,"file":null,"sources":["../src/parent.js","../src/iframe.js","../src/index.js"],"sourcesContent":["import 'jquery';\nimport formHelper from 'formhelper';\nimport Cookies from 'cookies-js';\nimport Porthole from 'porthole';\n\nconst $ = jQuery;\n\nfunction connect(rule) {\n\n  let porthole = null;\n\n  rule = jQuery.extend({\n    form: '#formhelper-peer-iframe--parent-form',\n    frame: '#formhelper-peer-iframe--iframe'\n  }, rule);\n\n  if (!rule.peerProxyUrl) { throw new Error('Missing `peerProxyUrl` in formhelper-peer-iframe/parent.js'); }\n\n  function checkReady() {\n    if (!rule.readyHasBeenAcknowledged) {\n      porthole.post({event: 'fh-ipeer-ready'});\n      window.setTimeout(checkReady, 100);\n    }\n  }\n\n  $(function() {\n\n    const $form = $(rule.form);\n    const $frame = $(rule.frame);\n\n    if ($form.length !== 1 || $frame.length !== 1) return;\n\n    const frameName = $frame.attr('name');\n\n    if (!frameName) { throw new Error('Missing iframe `name` attribute in formhelper-peer-iframe/parent.js'); }\n\n    rule.requestController = FormHelperPeerRequest\n    rule.readyHasBeenAcknowledged = false;\n\n    formHelper.addRule(rule);\n\n    porthole = new Porthole.WindowProxy(rule.peerProxyUrl, frameName);\n\n    formHelper.portholeSendFHIPeerCustomEvent = function(data) {\n      porthole.post({event: 'fh-ipeer-custom-event', data});\n    };\n\n    porthole.addEventListener(function(messageEvent) {\n\n      const data = messageEvent.data;\n\n      switch (data.event) {\n\n        case 'fh-ipeer-child-resize':\n          $frame.height(data.bodyHeight);\n          break;\n\n        case 'fh-ipeer-child-submit':\n          $form.submit();\n          break;\n\n        case 'fh-ipeer-ready':\n          porthole.post({event: 'fh-ipeer-ready-ack'});\n          break;\n\n        case 'fh-ipeer-ready-ack':\n          rule.readyHasBeenAcknowledged  = true;\n          break;\n      }\n    });\n\n    if (rule.onIframeCustomEvent) {\n      porthole.addEventListener(\n        function(messageEvent) {\n          const data = messageEvent.data;\n          if (data.event == 'fh-ipeer-custom-event') {\n            rule.onIframeCustomEvent(data.data);\n          }\n        }\n      );\n    }\n\n    window.setTimeout(checkReady, 0);\n\n  });\n};\n\n\nfunction FormHelperPeerRequest(formEl, rule, submitEvent) {\n  this.iframeResponse = null;\n\n  this.peerSubmitCompleteHandler = $.proxy(this.peerSubmitCompleteHandler, this);\n  porthole.addEventListener(this.peerSubmitCompleteHandler);\n\n  this.initialize(formEl, rule, submitEvent);\n}\n\nFormHelperPeerRequest.Defaults = {\n  rule:       {},\n  xhrOptions: {}\n};\n\n\nconst FormHelperRequest = formHelper.FormHelperRequest;\nFormHelperPeerRequest.prototype = new FormHelperRequest(null, {});\n\n\n$.extend(FormHelperPeerRequest.prototype, {\n\n  startXHR: function() {\n\n    // Get the form ready to submit...\n    this.checkoutForm();\n    this.hideAllStatusMessages();\n    this.hideAllErrorMessages();\n    this.hideAllParamMessages();\n    this.clearAllErroredFields();\n    this.disableControls();\n\n    // But don't actually submit it yet, just notify the iframe form to do its thing\n    porthole.post({event: 'fh-ipeer-parent-submit'});\n  },\n\n  resumeXHR: function(response) {\n\n    this.iframeResponse = response;\n\n    this.xhrOptions.data['peer-status'] = response.status || 'UNKNOWN';\n\n    this.savePeerCookies(response.data);\n\n    FormHelperRequest.prototype.startXHR.call(this);\n  },\n\n  xhrSuccess: function(data, textStatus, jqXHR) {\n\n    if (this.iframeResponse) {\n      if (this.iframeResponse.status !== 'SUCCESS') {\n        data.status = this.iframeResponse.status;\n      }\n      if (this.iframeResponse.errors) {\n        if (data.errors) {\n          data.errors = data.errors.concat(this.iframeResponse.errors);\n        } else {\n          data.errors = this.iframeResponse.errors;\n        }\n      }\n    }\n\n    porthole.post({event: 'fh-ipeer-parent-response-received', status: data.status});\n\n    FormHelperRequest.prototype.xhrSuccess.call(this, data, textStatus, jqXHR);\n  },\n\n  savePeerCookies: function(data) {\n    if (!data) return;\n\n    const peerCookies = data.peerCookies;\n\n    if (peerCookies) {\n      for (let i = 0, len = peerCookies.length; i < len; i++) {\n        const cookie = peerCookies[i];\n        Cookies.set(cookie.name, cookie.value, {path: '/'});\n      }\n    }\n  },\n\n  peerSubmitCompleteHandler: function(messageEvent) {\n    const data = messageEvent.data;\n\n    switch (data.event) {\n      case 'fh-ipeer-child-response-received':\n        this.resumeXHR(data.responseData);\n        porthole.removeEventListener(this.peerSubmitCompleteHandler);\n        break;\n    }\n  }\n\n});\n\nexport { connect };","import 'jquery';\nimport formHelper from 'formhelper';\nimport Porthole from 'porthole';\n\nconst $ = jQuery;\n\nfunction connect(config = {}) {\n\n  config = $.extend({\n    form: '#formhelper-peer-iframe--iframe-form'\n  }, config);\n\n  if (!config.peerProxyUrl) {\n    throw new Error('Missing `peerProxyUrl` in formhelper-peer-iframe/iframe.js');\n  }\n\n  let porthole = null;\n  let formHelperRequest = null;\n  let ready = false;\n  let $body = null;\n\n  function resizeFrame() {\n    const bodyHeight = $body.height();\n    porthole.post({event: 'fh-ipeer-child-resize', bodyHeight});\n  }\n\n  function checkReady(cb) {\n    if (ready) {\n      if (cb) { cb(); }\n    } else {\n      porthole.post({event: 'fh-ipeer-ready'});\n      window.setTimeout(_ => {\n        checkReady(cb)\n      }, 100);\n    }\n  }\n\n  function handleParentMessage(messageEvent) {\n\n    const data = messageEvent.data;\n\n    switch (data.event) {\n\n      case 'fh-ipeer-parent-submit':\n        formHelperRequest = new formHelper.FormHelperRequest($form, rule);\n        break;\n\n      case 'fh-ipeer-parent-response-received':\n        if (data.status !== 'SUCCESS') {\n          formHelperRequest.releaseForm();\n        }\n        formHelperRequest.updateUI();\n        resizeFrame();\n        break;\n\n      case 'fh-ipeer-ready':\n        porthole.post({event: 'fh-ipeer-ready-ack'});\n        break;\n\n      case 'fh-ipeer-ready-ack':\n        ready = true;\n        break;\n\n      case 'fh-ipeer-custom-event':\n        if (formHelper.always) {\n          if(formHelper.always.onIframeCustomEvent) {\n            formHelper.always.onIframeCustomEvent(data.data);\n          }\n        }\n        break;\n    }\n  };\n\n\n  $(_ => {\n\n    const $form = $(config.form);\n\n    if ($form.length !== 1) return;\n\n    $body = $('body');\n\n    var rule = {\n      form,\n      xhrSuccess() {\n        formHelperRequest = this;\n\n        porthole.post({event: 'fh-ipeer-child-response-received', responseData: {\n          data:   this.data,\n          errors: this.errors,\n          status: this.status\n        }});\n\n      },\n      onComplete() {\n        resizeFrame();\n      },\n      customSubmitHandler() {\n        porthole.post({event: 'fh-ipeer-child-submit'});\n      },\n      releaseFormAndUpdateUIOnXHRSuccess: false\n    };\n\n    formHelper.addRule(rule);\n\n    porthole = new Porthole.WindowProxy(peerProxyUrl);\n\n    formHelper.portholeSendFHIPeerCustomEvent = function(data) {\n      porthole.post({event: 'fh-ipeer-custom-event', data: data});\n    };\n\n    porthole.addEventListener(handleParentMessage);\n\n    window.setTimeout(_ => {\n      checkReady(_ => {\n        resizeFrame();\n        $(window).resize(resizeFrame);\n      }, 100)\n    }, 0);\n\n  });\n}\n\nexport { connect };","import { connect as connectParent } from './parent.js';\nimport { connect as connectIframe } from './iframe.js';\n\n\nfunction connect(formRuleParent, configIframe) {\n  connectParent(formRuleParent);\n  connectIframe(configIframe);\n}\n\n\nexport { connect };\n\n/**\n * formRuleParent\n *   Standard formRule with a few extra properties:\n *   \n *     form\n *       Default: #formhelper-peer-iframe--parent-form\n *\n *     frame\n *       Default: #formhelper-peer-iframe--iframe'\n *       iframe selector (override as needed)\n *\n *     peerProxyUrl\n *       Required. URL to proxy html file on the *child* domain.\n *       Example: http://child-domain.com/js/porthole/proxy.html\n *\n * \n * configIframe\n *   Not a full formRule but the following two properties:\n * \n *     form\n *       Child iframe form's selector (override as needed)\n *       Default: #formhelper-peer-iframe--iframe-form\n *   \n *     peerProxyUrl\n *       Required. URL to proxy html file on the *parent* domain.\n *       Example: http://parent-domain.com/js/porthole/proxy.html\n */\n\n/**\n * Note that for now both the parent and iframe forms are only\n * registered to formhelper if the specified form is found on\n * DOMContentLoaded. This is to prevent the Porthole proxy setup\n * on pages where it's not needed.\n */\n\n\n/*\nProxy template:\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <script src=\" ... porthole.min.js\"></script>\n    <script>window.onload=function() { Porthole.WindowProxyDispatcher.start(); };</script>\n  </head>\n  <body></body>\n</html>\n*/"],"names":["$","jQuery","connect","rule","porthole","extend","peerProxyUrl","Error","checkReady","readyHasBeenAcknowledged","post","event","setTimeout","$form","form","$frame","frame","length","frameName","attr","requestController","FormHelperPeerRequest","addRule","Porthole","WindowProxy","portholeSendFHIPeerCustomEvent","data","addEventListener","messageEvent","height","bodyHeight","submit","onIframeCustomEvent","formEl","submitEvent","iframeResponse","peerSubmitCompleteHandler","proxy","initialize","Defaults","FormHelperRequest","formHelper","prototype","checkoutForm","hideAllStatusMessages","hideAllErrorMessages","hideAllParamMessages","clearAllErroredFields","disableControls","response","xhrOptions","status","savePeerCookies","startXHR","call","textStatus","jqXHR","errors","concat","xhrSuccess","peerCookies","i","len","cookie","set","name","value","path","resumeXHR","responseData","removeEventListener","config","formHelperRequest","ready","$body","resizeFrame","cb","handleParentMessage","releaseForm","updateUI","always","window","resize","formRuleParent","configIframe"],"mappings":"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"}